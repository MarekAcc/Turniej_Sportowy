{% extends "base_admin.html" %}

{% block title %}Zarządzanie Turniejem - {{ tournament.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h1 class="h3 mb-0">Turniej: {{ tournament.name }}</h1>
        </div>
        <div class="card-body">
            <p><strong>Typ turnieju:</strong> {{ tournament.type }}</p>
            <p><strong>Status:</strong> {{ tournament.status }}</p>
            <p><strong>Runda:</strong> {{ tournament.round }}</p>
        </div>
    </div>
</div>

{% if tournament.type == 'league' %}
<h2>Tabela Ligowa</h2>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Drużyna</th>
            <th>Punkty</th>
        </tr>
    </thead>
    <tbody>
        {% for team, points in ranking.items() %}
        <tr>
            <td><a href="{{ url_for('views.team_details', team_id=team.id) }}">{{ team.name }}</a></td>
            <td>{{ points }}</td>
        </tr>
        {% else %}
        <tr>
            <td colspan="2" class="text-center">Brak wyników</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if tournament.type == 'playoff' %}
<h2>Drabinka Turniejowa</h2>
<style>
.tournament-bracket {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 20px;
}

.round {
    display: flex;
    flex-direction: column;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
}

.round h3 {
    text-align: center;
    margin-bottom: 10px;
}

.round ul {
    list-style: none;
    padding: 0;
}

.match-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.1s ease-in-out;
    border-radius: 5px;
}

.match-item:hover {
    background-color: #f8f9fa;
    transform: scale(1.02);
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.15);
}

.team-name {
    display: flex;
    align-items: center;
    font-weight: bold;
    font-size: 18px;
}

.team-name img {
    width: 24px;
    height: 24px;
    margin-right: 8px;
    border-radius: 50%;
    object-fit: cover;
}

.match-score {
    font-size: 20px;
    font-weight: bold;
    color: #333;
    min-width: 60px;
    text-align: center;
}

</style>
<div class="tournament-bracket">
    {% for round_number, matches_in_round in rounds.items() %}
    <div class="round">
        <h3>Runda {{ round_number }}</h3>
        <ul>
            {% for match in matches_in_round %}
            <li class="match-item {% if match.status == 'planned' %}clickable{% endif %}" 
                {% if match.status == 'planned' %}
                data-toggle="modal" data-target="#matchModal" data-match-id="{{ match.id }}"
                {% endif %}>
                <span class="team-name">{{ match.home_team.name }}</span>
                <span class="match-score">
                    {{ match.scoreHome if match.scoreHome is not none else "-" }} :
                    {{ match.scoreAway if match.scoreAway is not none else "-" }}
                </span>
                <span class="team-name">{{ match.away_team.name }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>
<!-- Okno modalne do wyboru akcji meczu -->
<div class="modal fade" id="matchModal" tabindex="-1" aria-labelledby="matchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="matchModalLabel">Wybierz akcję</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="matchActionForm" method="POST">
                    <input type="hidden" name="match_id" id="modalMatchId">
                    <div class="form-group">
                        <label for="actionType">Akcja:</label>
                        <select name="action_type" id="actionType" class="form-control">
                            <option value="add_result">Dodanie wyniku meczu</option>
                            <option value="assign_referee">Przypisanie sędziego do meczu</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Wykonaj</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- <h2 class="mt-4">Mecze</h2>
<form method="POST">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Wybierz</th>
                <th>Gospodarz</th>
                <th>Gość</th>
                <th>Status</th>
                <th>Sędzia</th>
                <th>Akcja</th>
            </tr>
        </thead>
        <tbody>
            {% for match in matches %}
            {% if match.status in ['managed', 'planned', 'ended'] %}
            <tr>
                <td>
                    <input type="radio" name="match_id" value="{{ match.id }}" onchange="enableAction(this)">
                </td>
                <td>{{ match.home_team.name }}</td>
                <td>{{ match.away_team.name }}</td>
                <td>{{ match.status }}</td>
                <td>{% if match.referee %}{{ match.referee.firstName }} {{ match.referee.lastName }}{% else %}--{% endif %}</td>
                <td>
                    {% if match.status == 'planned' %}
                    <select name="action_type" class="form-control" disabled>
                        <option>Dodanie wyniku meczu</option>
                        {% if not match.referee %}
                        <option>Przypisanie sędziego do meczu</option>
                        {% endif %}
                    </select>
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Wykonaj</button>
</form> -->

<div class="actions mt-3">
    <form method="POST" action="{{ url_for('admin.cancel_tournament', tournament_id=tournament.id) }}">
        <button type="submit" class="btn btn-danger">Przerwij turniej</button>
    </form>
    <form method="POST" action="{{ url_for('admin.end_tournament', tournament_id=tournament.id) }}">
        <button type="submit" class="btn btn-warning mt-2">Zakończ turniej</button>
    </form>
    <form method="POST" action="{{ url_for('admin.delete_tournament', tournament_id=tournament.id) }}">
        <button type="submit" class="btn btn-danger mt-2">Usuń turniej</button>
    </form>
    {% if tournament.type == 'playoff' %}
    <form method="POST" action="{{ url_for('admin.draw_next_round', tournament_id=tournament.id) }}">
        <button type="submit" class="btn btn-primary mt-2">Losuj kolejną rundę</button>
    </form>
    {% endif %}
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".match-item").forEach(function(item) {
            item.addEventListener("click", function() {
                let matchId = this.getAttribute("data-match-id");
                document.getElementById("modalMatchId").value = matchId;
            });
        });

        document.getElementById("matchActionForm").addEventListener("submit", function(event) {
            event.preventDefault();  // Zapobiega przeładowaniu strony
            let formData = new FormData(this);
            // process_match_action
            fetch("{{ url_for('admin.home_admin') }}", {
                method: "POST",
                body: formData
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert("Akcja wykonana!");
                      location.reload();
                  } else {
                      alert("Wystąpił błąd: " + data.error);
                  }
              });
        });
    });
</script>
{% endblock %}